<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>V4 - PokÃ©mon Emulator</title>
  <style>
    body {
      margin: 0;
      background: black;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      font-family: sans-serif;
      height: 100vh;
    }
    h2 { margin: 10px; }
    #game { width: 100%; height: 70%; }
    #controls {
      width: 100%; height: 10%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      background: #111;
    }
    button { 
      background: #333; color: white; border: none;
      padding: 10px 20px; border-radius: 8px;
      cursor: pointer; font-size: 16px;
    }
    button:hover { background: #555; }
    #fileInput { margin: 20px; font-size: 18px; }
  </style>
</head>
<body>
  <h2>ðŸŽ® PokÃ©mon Emulator</h2>
  <input type="file" id="fileInput" accept=".gba,.gb,.gbc">
  <div id="game"></div>
  <div id="controls" style="display:none;">
    <button id="saveBtn">ðŸ’¾ Save Now</button>
    <button id="loadBtn">ðŸ“‚ Load Save</button>
  </div>

  <!-- EmulatorJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/emulatorjs@latest/dist/emulator.min.js"></script>
  <script>
    const gameElement = document.getElementById("game");
    const controls = document.getElementById("controls");
    const saveBtn = document.getElementById("saveBtn");
    const loadBtn = document.getElementById("loadBtn");
    const fileInput = document.getElementById("fileInput");

    let emulator;
    let currentRomName = null;

    // Detect emulator type from file extension
    function getEmulatorType(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      if (ext === "gba") return "gba";
      if (ext === "gbc") return "gbc";
      if (ext === "gb") return "gb";
      return "gba"; // fallback
    }

    function startEmulator(romData, romName) {
      currentRomName = romName;

      emulator = new EmulatorJS({
        type: getEmulatorType(romName),
        element: gameElement,
      });

      emulator.loadGame(romData).then(() => {
        console.log("Game loaded:", romName);

        // Show controls
        controls.style.display = "flex";

        // Restore save if exists
        const savedata = localStorage.getItem("save_" + romName);
        if (savedata) {
          emulator.loadSaveState(JSON.parse(savedata));
          console.log("Save loaded.");
        }

        // Auto-save every 20 sec
        setInterval(async () => {
          if (emulator) {
            const save = await emulator.saveState();
            localStorage.setItem("save_" + romName, JSON.stringify(save));
            console.log("Game auto-saved.");
          }
        }, 20000);
      }).catch(err => {
        console.error("Failed to load emulator:", err);
        alert("Failed to load ROM. Make sure the file is a valid GBA/GBC/GB ROM.");
      });
    }

    // File input listener
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          startEmulator(ev.target.result, file.name);
        };
        reader.readAsArrayBuffer(file);
      }
    });

    // Manual Save
    saveBtn.addEventListener("click", async () => {
      if (emulator && currentRomName) {
        const save = await emulator.saveState();
        localStorage.setItem("save_" + currentRomName, JSON.stringify(save));
        alert("Game saved!");
      }
    });

    // Manual Load
    loadBtn.addEventListener("click", async () => {
      if (emulator && currentRomName) {
        const savedata = localStorage.getItem("save_" + currentRomName);
        if (savedata) {
          emulator.loadSaveState(JSON.parse(savedata));
          alert("Save loaded!");
        } else {
          alert("No save found.");
        }
      }
    });
  </script>
</body>
</html>
